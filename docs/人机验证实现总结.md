# äººæœºéªŒè¯åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç»„ä»¶

#### å‰ç«¯ç»„ä»¶
- âœ… `CaptchaVerification.vue` - é€šç”¨äººæœºéªŒè¯ç»„ä»¶
  - æ”¯æŒ Cloudflare Turnstile
  - æ”¯æŒ Google reCAPTCHA
  - æ”¯æŒè‡ªå®šä¹‰æ»‘å—éªŒè¯
  - è‡ªåŠ¨åŠ è½½æ‰€éœ€è„šæœ¬
  - æ”¯æŒäº®è‰²/æš—è‰²ä¸»é¢˜

#### åç«¯æœåŠ¡
- âœ… `CaptchaService.java` - äººæœºéªŒè¯æ ¸å¿ƒæœåŠ¡
  - éªŒè¯ Cloudflare Turnstile token
  - éªŒè¯ Google reCAPTCHA token
  - éªŒè¯æ»‘å—éªŒè¯ token
  - åˆ¤æ–­æ˜¯å¦éœ€è¦éªŒè¯çš„é€»è¾‘

- âœ… `SliderCaptchaService.java` - å¢å¼ºçš„æ»‘å—éªŒè¯æœåŠ¡
  - é¢‘ç‡é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿ/æ¯å°æ—¶ï¼‰
  - é˜²é‡æ”¾æ”»å‡»
  - è¡Œä¸ºæ£€æµ‹ï¼ˆUser-Agentã€Referer ç­‰ï¼‰
  - è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

#### æ§åˆ¶å™¨
- âœ… `CaptchaController.java` - äººæœºéªŒè¯ API
  - `/api/captcha/config` - è·å–éªŒè¯é…ç½®
  - `/api/captcha/verify` - éªŒè¯ token
  - ä½¿ç”¨ç»Ÿä¸€è¿”å›ç±» `Result`
  - è·å–å®¢æˆ·ç«¯çœŸå® IP

### 2. ç¤ºä¾‹ä»£ç 

- âœ… `LoginExample.vue` - ç™»å½•é¡µé¢é›†æˆç¤ºä¾‹
  - å±•ç¤ºå¦‚ä½•ä½¿ç”¨éªŒè¯ç»„ä»¶
  - å±•ç¤ºå¦‚ä½•å¤„ç†éªŒè¯æˆåŠŸ/å¤±è´¥
  - å±•ç¤ºå¦‚ä½•é‡ç½®éªŒè¯

### 3. é…ç½®æ–‡ä»¶

- âœ… `captcha-config-example.yml` - é…ç½®ç¤ºä¾‹
- âœ… `application-captcha-template.yml` - é…ç½®æ¨¡æ¿

### 4. æ–‡æ¡£

- âœ… `Cloudflare-Turnstile-ä½¿ç”¨æŒ‡å—.md` - è¯¦ç»†çš„ Turnstile ä½¿ç”¨æŒ‡å—
- âœ… `äººæœºéªŒè¯æ–¹æ¡ˆé€‰æ‹©.md` - ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”å’Œé€‰æ‹©å»ºè®®

### 5. é¡¹ç›®è§„èŒƒ

- âœ… æ›´æ–° `.cursorrules` æ·»åŠ ï¼š
  - ç»Ÿä¸€è¿”å›ç±» Result ä½¿ç”¨è§„èŒƒ
  - Servlet API ç‰ˆæœ¬è§„èŒƒï¼ˆjakarta.servletï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨æ»‘å—éªŒè¯ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

#### 1. é…ç½®åç«¯

åœ¨ `application.yml` ä¸­æ·»åŠ ï¼š

```yaml
captcha:
  enabled: true
  type: slider
```

#### 2. å‰ç«¯ä½¿ç”¨

```vue
<template>
  <form @submit.prevent="handleLogin">
    <input v-model="username" placeholder="ç”¨æˆ·å" />
    <input v-model="password" type="password" placeholder="å¯†ç " />
    
    <CaptchaVerification
      ref="captchaRef"
      type="slider"
      @verified="captchaToken = $event"
    />
    
    <button type="submit" :disabled="!captchaToken">ç™»å½•</button>
  </form>
</template>

<script setup>
import { ref } from 'vue';
import CaptchaVerification from '@/components/CaptchaVerification.vue';

const username = ref('');
const password = ref('');
const captchaToken = ref('');
const captchaRef = ref(null);

const handleLogin = async () => {
  try {
    const response = await axios.post('/api/auth/login', {
      username: username.value,
      password: password.value,
      captchaToken: captchaToken.value
    });
    
    if (response.data.code === 200) {
      // ç™»å½•æˆåŠŸ
    }
  } catch (error) {
    // ç™»å½•å¤±è´¥ï¼Œé‡ç½®éªŒè¯
    captchaRef.value?.reset();
    captchaToken.value = '';
  }
};
</script>
```

#### 3. åç«¯éªŒè¯

```java
@PostMapping("/login")
public Result<LoginVO> login(@RequestBody LoginDTO dto, HttpServletRequest request) {
    // 1. éªŒè¯äººæœºéªŒè¯
    String remoteIp = getClientIp(request);
    boolean captchaValid = captchaService.verifyCaptcha(dto.getCaptchaToken(), remoteIp);
    
    if (!captchaValid) {
        return Result.badRequest("äººæœºéªŒè¯å¤±è´¥");
    }
    
    // 2. éªŒè¯ç”¨æˆ·åå¯†ç 
    // ... æ‚¨çš„ç™»å½•é€»è¾‘
    
    return Result.success(loginVO);
}
```

---

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Cloudflare Turnstile

#### 1. è·å–å¯†é’¥

1. è®¿é—® https://dash.cloudflare.com/
2. è¿›å…¥ Turnstile é¡µé¢
3. åˆ›å»ºä¸€ä¸ªæ–°çš„ site
4. å¤åˆ¶ Site Key å’Œ Secret Key

#### 2. é…ç½®åç«¯

åœ¨ `application.yml` ä¸­æ·»åŠ ï¼š

```yaml
captcha:
  enabled: true
  type: turnstile
  site-key: YOUR_SITE_KEY_HERE
  secret-key: YOUR_SECRET_KEY_HERE
```

#### 3. å‰ç«¯ä½¿ç”¨

```vue
<CaptchaVerification
  type="turnstile"
  site-key="YOUR_SITE_KEY_HERE"
  @verified="captchaToken = $event"
/>
```

#### 4. åç«¯éªŒè¯

ä¸æ»‘å—éªŒè¯ç›¸åŒï¼Œ`CaptchaService` ä¼šè‡ªåŠ¨æ ¹æ®é…ç½®é€‰æ‹©éªŒè¯æ–¹å¼ã€‚

---

## ğŸ“‹ ä»€ä¹ˆæƒ…å†µéœ€è¦äººæœºéªŒè¯ï¼Ÿ

### âœ… å¿…é¡»ä½¿ç”¨çš„åœºæ™¯

1. **ç”¨æˆ·æ³¨å†Œ/ç™»å½•**
   ```java
   if (captchaService.requiresCaptcha("login", null)) {
       // éœ€è¦éªŒè¯
   }
   ```

2. **å¯†ç é‡ç½®**
   ```java
   if (captchaService.requiresCaptcha("reset-password", null)) {
       // éœ€è¦éªŒè¯
   }
   ```

3. **å‘å¸ƒå†…å®¹**ï¼ˆè¯„è®ºã€è§†é¢‘ã€æ–‡ç« ï¼‰
   ```java
   if (captchaService.requiresCaptcha("post", userId)) {
       // éœ€è¦éªŒè¯
   }
   ```

4. **æŠ•ç¥¨/ç‚¹èµ**
   ```java
   if (captchaService.requiresCaptcha("like", userId)) {
       // éœ€è¦éªŒè¯
   }
   ```

### âš ï¸ å»ºè®®ä½¿ç”¨çš„åœºæ™¯

1. æœç´¢åŠŸèƒ½ï¼ˆé˜²æ­¢çˆ¬è™«ï¼‰
2. è¡¨å•æäº¤
3. ä¸‹è½½èµ„æº
4. API é¢‘ç¹è°ƒç”¨

### âŒ ä¸å»ºè®®ä½¿ç”¨çš„åœºæ™¯

1. æ™®é€šé¡µé¢æµè§ˆ
2. æŸ¥çœ‹ä¸ªäººä¿¡æ¯
3. é™æ€å†…å®¹è®¿é—®

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. å¯†é’¥ç®¡ç†

âŒ **ä¸è¦è¿™æ ·åšï¼š**
```yaml
# ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­å¹¶æäº¤åˆ° Git
captcha:
  secret-key: 0x4AAAAAAAyyyyyyyyyyyyyyyyyyyy
```

âœ… **åº”è¯¥è¿™æ ·åšï¼š**
```yaml
# ä½¿ç”¨ç¯å¢ƒå˜é‡
captcha:
  secret-key: ${CAPTCHA_SECRET_KEY}
```

ç„¶ååœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š
```bash
export CAPTCHA_SECRET_KEY=0x4AAAAAAAyyyyyyyyyyyyyyyyyyyy
```

### 2. é…ç½®æ–‡ä»¶åˆ†ç¦»

```
application.yml              # å…¬å…±é…ç½®
application-dev.yml          # å¼€å‘ç¯å¢ƒï¼ˆå¯ä»¥æäº¤ï¼‰
application-prod.yml         # ç”Ÿäº§ç¯å¢ƒï¼ˆä¸æäº¤ï¼ŒåŠ å…¥ .gitignoreï¼‰
```

### 3. åç«¯éªŒè¯

âš ï¸ **é‡è¦ï¼š** å‰ç«¯éªŒè¯åªæ˜¯ UI å±‚é¢ï¼Œå¿…é¡»åœ¨åç«¯éªŒè¯ Tokenï¼

```java
// âŒ é”™è¯¯ï¼šåªåœ¨å‰ç«¯éªŒè¯
if (captchaToken) {
    // ç›´æ¥ç™»å½•
}

// âœ… æ­£ç¡®ï¼šåç«¯éªŒè¯
boolean valid = captchaService.verifyCaptcha(token, ip);
if (!valid) {
    return Result.badRequest("éªŒè¯å¤±è´¥");
}
```

### 4. IP éªŒè¯

```java
// è·å–çœŸå® IP
String realIp = getClientIp(request);

// ä¼ é€’ç»™éªŒè¯æœåŠ¡
captchaService.verifyCaptcha(token, realIp);
```

### 5. Token å•æ¬¡ä½¿ç”¨

æ¯ä¸ª Token åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ŒéªŒè¯åç«‹å³å¤±æ•ˆã€‚

---

## ğŸ¯ é›†æˆåˆ°ç°æœ‰åŠŸèƒ½

### ç™»å½•åŠŸèƒ½

åœ¨ `AuthController.java` ä¸­ï¼š

```java
@PostMapping("/login")
public Result<LoginVO> login(@RequestBody LoginDTO dto, HttpServletRequest request) {
    // éªŒè¯äººæœºéªŒè¯
    if (!captchaService.verifyCaptcha(dto.getCaptchaToken(), getClientIp(request))) {
        return Result.badRequest("äººæœºéªŒè¯å¤±è´¥");
    }
    
    // åŸæœ‰çš„ç™»å½•é€»è¾‘
    // ...
}
```

åœ¨ `LoginDTO.java` ä¸­æ·»åŠ ï¼š

```java
@Data
public class LoginDTO {
    private String username;
    private String password;
    private String captchaToken; // æ–°å¢
}
```

### æ³¨å†ŒåŠŸèƒ½

```java
@PostMapping("/register")
public Result<Void> register(@RequestBody RegisterDTO dto, HttpServletRequest request) {
    // éªŒè¯äººæœºéªŒè¯
    if (!captchaService.verifyCaptcha(dto.getCaptchaToken(), getClientIp(request))) {
        return Result.badRequest("äººæœºéªŒè¯å¤±è´¥");
    }
    
    // åŸæœ‰çš„æ³¨å†Œé€»è¾‘
    // ...
}
```

### å‘å¸ƒè§†é¢‘

```java
@PostMapping("/videos")
public Result<VideoVO> uploadVideo(@RequestBody VideoDTO dto, HttpServletRequest request) {
    // éªŒè¯äººæœºéªŒè¯
    if (!captchaService.verifyCaptcha(dto.getCaptchaToken(), getClientIp(request))) {
        return Result.badRequest("äººæœºéªŒè¯å¤±è´¥");
    }
    
    // åŸæœ‰çš„ä¸Šä¼ é€»è¾‘
    // ...
}
```

### å‘å¸ƒè¯„è®º

```java
@PostMapping("/comments")
public Result<CommentVO> addComment(@RequestBody CommentDTO dto, HttpServletRequest request) {
    // éªŒè¯äººæœºéªŒè¯
    if (!captchaService.verifyCaptcha(dto.getCaptchaToken(), getClientIp(request))) {
        return Result.badRequest("äººæœºéªŒè¯å¤±è´¥");
    }
    
    // åŸæœ‰çš„è¯„è®ºé€»è¾‘
    // ...
}
```

---

## ğŸ§ª æµ‹è¯•

### 1. æµ‹è¯•æ»‘å—éªŒè¯

```bash
# å¯åŠ¨åç«¯
cd d:\Projects\ViewX
mvn spring-boot:run

# è®¿é—®æµ‹è¯•é¡µé¢
http://localhost:8080/login
```

### 2. æµ‹è¯• Turnstile

Cloudflare æä¾›æµ‹è¯•å¯†é’¥ï¼š

```yaml
captcha:
  type: turnstile
  site-key: 1x00000000000000000000AA
  secret-key: 1x0000000000000000000000000000000AA
```

è¿™äº›å¯†é’¥ä¼šå§‹ç»ˆè¿”å›æˆåŠŸï¼Œç”¨äºå¼€å‘æµ‹è¯•ã€‚

### 3. æµ‹è¯• API

```bash
# æµ‹è¯•è·å–é…ç½®
curl http://localhost:8080/api/captcha/config

# æµ‹è¯•éªŒè¯
curl -X POST http://localhost:8080/api/captcha/verify \
  -H "Content-Type: application/json" \
  -d '{"token": "slider-verified"}'
```

---

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### è·å–éªŒè¯ç»Ÿè®¡

```java
@GetMapping("/captcha/stats")
public Result<Map<String, Object>> getStats(HttpServletRequest request) {
    String ip = getClientIp(request);
    Map<String, Object> stats = sliderCaptchaService.getStats(ip);
    return Result.success(stats);
}
```

è¿”å›ç¤ºä¾‹ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "attempts": 5,
    "successCount": 3,
    "blocked": false
  }
}
```

---

## â“ å¸¸è§é—®é¢˜

### Q: éœ€è¦ä¿®æ”¹ DNS å—ï¼Ÿ
**A:** ä¸éœ€è¦ï¼Cloudflare Turnstile æ˜¯ç‹¬ç«‹çš„éªŒè¯æœåŠ¡ï¼Œä¸éœ€è¦ä¿®æ”¹ DNSã€‚

### Q: ä¼šå½±å“ç½‘ç«™é€Ÿåº¦å—ï¼Ÿ
**A:** ä¸ä¼šã€‚åªåœ¨éœ€è¦éªŒè¯æ—¶åŠ è½½ä¸€ä¸ªå°è„šæœ¬ï¼ˆçº¦ 50KBï¼‰ã€‚

### Q: åœ¨ä¸­å›½èƒ½ç”¨å—ï¼Ÿ
**A:** Turnstile å¯ä»¥è®¿é—®ï¼Œä½†é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ã€‚å»ºè®®ä½¿ç”¨æ»‘å—éªŒè¯ã€‚

### Q: å¦‚ä½•åˆ‡æ¢éªŒè¯æ–¹å¼ï¼Ÿ
**A:** åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ `type` å­—æ®µï¼Œå‰ç«¯ä¼šè‡ªåŠ¨é€‚é…ã€‚

### Q: Token å¯ä»¥é‡å¤ä½¿ç”¨å—ï¼Ÿ
**A:** ä¸å¯ä»¥ã€‚æ¯ä¸ª Token åªèƒ½éªŒè¯ä¸€æ¬¡ã€‚

### Q: å¦‚ä½•ä¸´æ—¶ç¦ç”¨éªŒè¯ï¼Ÿ
**A:** åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `enabled: false`ã€‚

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒä»£ç 
- `src/main/java/com/flowbrain/viewx/service/CaptchaService.java`
- `src/main/java/com/flowbrain/viewx/service/SliderCaptchaService.java`
- `src/main/java/com/flowbrain/viewx/controller/CaptchaController.java`
- `ViewX-frontend/src/components/CaptchaVerification.vue`

### ç¤ºä¾‹ä»£ç 
- `ViewX-frontend/src/views/LoginExample.vue`

### é…ç½®æ–‡ä»¶
- `src/main/resources/application-captcha-template.yml`
- `src/main/resources/captcha-config-example.yml`

### æ–‡æ¡£
- `docs/Cloudflare-Turnstile-ä½¿ç”¨æŒ‡å—.md`
- `docs/äººæœºéªŒè¯æ–¹æ¡ˆé€‰æ‹©.md`

---

## ğŸ‰ æ€»ç»“

æ‚¨ç°åœ¨å·²ç»æ‹¥æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„äººæœºéªŒè¯ç³»ç»Ÿï¼š

âœ… **ä¸‰ç§éªŒè¯æ–¹å¼**ï¼šTurnstileã€reCAPTCHAã€æ»‘å—
âœ… **å¼€ç®±å³ç”¨**ï¼šæ— éœ€ä¿®æ”¹ DNSï¼Œæ— éœ€å¤æ‚é…ç½®
âœ… **å®‰å…¨å¯é **ï¼šé¢‘ç‡é™åˆ¶ã€é˜²é‡æ”¾ã€è¡Œä¸ºæ£€æµ‹
âœ… **æ˜“äºé›†æˆ**ï¼šç»Ÿä¸€çš„ APIï¼Œç®€å•çš„ä½¿ç”¨æ–¹å¼
âœ… **çµæ´»åˆ‡æ¢**ï¼šä¿®æ”¹é…ç½®å³å¯åˆ‡æ¢éªŒè¯æ–¹å¼

**æ¨èä½¿ç”¨æ»‘å—éªŒè¯**ï¼Œç®€å•å¿«é€Ÿï¼Œæ— éœ€æ³¨å†Œä»»ä½•æœåŠ¡ï¼

å¦‚æœå°†æ¥éœ€è¦æ›´é«˜çš„å®‰å…¨æ€§ï¼Œå¯ä»¥éšæ—¶åˆ‡æ¢åˆ° Cloudflare Turnstileã€‚
