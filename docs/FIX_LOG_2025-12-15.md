# ViewX 问题修复记录

## 日期：2025-12-15

### 问题 1: 暗亮色模式切换不工作

**问题描述**：
- 移动端和 PC 端的设置页面中，暗亮色模式切换开关无法正常工作
- 点击开关后主题没有变化

**根本原因**：
1. `App.vue` 中没有实现 `toggleTheme` 函数
2. 没有监听 `theme` 变化并更新 DOM 属性
3. Settings 组件没有正确接收和传递 theme props

**解决方案**：

1. **在 `App.vue` 中实现主题切换逻辑**：
```typescript
const toggleTheme = () => {
  theme.value = theme.value === 'dark' ? 'light' : 'dark'
  localStorage.setItem('theme', theme.value)
}

// 监听主题变化
watch(theme, (newTheme) => {
  document.documentElement.setAttribute('data-theme', newTheme)
}, { immediate: true })
```

2. **传递 props 和事件到路由组件**：
```vue
<component :is="Component" :theme="theme" :isLoggedIn="isLoggedIn" @toggle-theme="toggleTheme" />
```

3. **Settings.vue 中使用 computed 属性**：
```typescript
const isDarkMode = computed({
  get: () => props.theme === 'dark',
  set: () => emit('toggle-theme')
})
```

**相关文件**：
- `src/App.vue`
- `src/views/Settings.vue`
- `src/styles/theme.scss`

---

### 问题 2: 浅色模式显示问题

**问题描述**：
1. 浅色模式下背景仍然是黑色
2. 字体太淡、太细，难以阅读
3. 组件悬停时玻璃效果不明显

**解决方案**：

1. **修复硬编码的背景色**：
```vue
<!-- 从 -->
<div class="bg-[#0f0f0f] text-white">
<!-- 改为 -->
<div class="bg-[var(--bg)] text-[var(--text)]">
```

2. **增强浅色模式字体**：
```scss
html[data-theme="light"] body {
  -webkit-font-smoothing: auto;
  -moz-osx-font-smoothing: auto;
  font-weight: 500; // 增加字重
}

body {
  font-size: 15px; // 从 14px 增加到 15px
}
```

3. **增强玻璃效果**：
```scss
[data-theme="light"] {
  --bg-glass: rgba(255, 255, 255, 0.45); // 降低透明度
  --border-hover: #94a3b8; // 更明显的边框
  --blur: 24px; // 增加模糊度
}
```

**相关文件**：
- `src/App.vue`
- `src/views/Profile.vue`
- `src/styles/theme.scss`

---

### 问题 3: Sidebar 导航高亮不准确

**问题描述**：
- 在设置页面时，"我的"按钮仍然保持高亮状态
- 导航项没有根据当前路由更新

**解决方案**：

在 `Sidebar.vue` 中添加路由监听：

```typescript
import { useRoute } from 'vue-router'

const route = useRoute()

watch(() => route.path, (newPath) => {
  if (newPath === '/') activeTab.value = 'home'
  else if (newPath.startsWith('/trending')) activeTab.value = 'trending'
  else if (newPath.startsWith('/subscriptions')) activeTab.value = 'subs'
  else if (newPath.startsWith('/library')) activeTab.value = 'library'
  else if (newPath.startsWith('/profile')) activeTab.value = 'profile'
  else if (newPath.startsWith('/settings')) activeTab.value = 'settings'
  else activeTab.value = ''
}, { immediate: true })
```

**相关文件**：
- `src/components/Sidebar.vue`

---

### 问题 4: GitHub OAuth 登录后前端未保持登录状态

**问题描述**：
- 使用 GitHub OAuth 登录成功后，前端没有保存 token
- 页面刷新后登录状态丢失

**根本原因**：
1. 后端重定向到 `/oauth/callback?token=xxx`
2. 前端没有对应的路由处理这个回调
3. Token 没有被保存到 localStorage

**解决方案**：

1. **创建 OAuth 回调页面** (`OAuthCallback.vue`)：
```typescript
const handleOAuthCallback = async () => {
  const token = route.query.token as string
  
  if (token) {
    // 保存 token
    localStorage.setItem('token', token)
    
    // 触发自定义事件通知 App.vue
    window.dispatchEvent(new CustomEvent('auth-state-changed', { 
      detail: { isLoggedIn: true } 
    }))
    
    // 跳转到首页
    router.replace('/')
  }
}
```

2. **添加路由配置**：
```typescript
{
  path: '/oauth/callback',
  name: 'oauth-callback',
  component: () => import('../views/OAuthCallback.vue'),
  meta: { hideHeader: true, hideNav: true, hideSidebar: true }
}
```

3. **在 App.vue 中监听状态变化**：
```typescript
onMounted(() => {
  window.addEventListener('auth-state-changed', handleAuthStateChange)
})

const handleAuthStateChange = (event: Event) => {
  const customEvent = event as CustomEvent
  if (customEvent.detail?.isLoggedIn) {
    checkAuth()
  }
}
```

**优化点**：
- 使用自定义事件而非页面刷新，避免重复加载
- 使用 `router.replace` 而非 `window.location.href`，提升用户体验
- 添加错误处理和友好的提示信息

**相关文件**：
- `src/views/OAuthCallback.vue` (新建)
- `src/router/index.ts`
- `src/App.vue`

---

### 问题 5: 版本检查接口 403 错误

**问题描述**：
- 访问 `/api/system/check-update` 返回 403 Forbidden
- 版本检查功能无法使用

**根本原因**：
- Spring Security 配置中没有将 `/system/**` 路径设置为公开访问

**解决方案**：

在 `SecurityConfig.java` 中添加：

```java
.requestMatchers("/auth/**",
        "/products/**",
        "/oauth2/**",
        "/email/**",
        "/store/**",
        "/system/**",  // 添加这一行
        "/v3/api-docs/**",
        // ...
).permitAll()
```

**相关文件**：
- `src/main/java/com/flowbrain/viewx/config/SecurityConfig.java`

---

## 新增功能：版本管理系统

### 功能概述

实现了完整的版本管理和自动更新系统，包括：

1. **后端版本管理**
   - `SystemVersionDTO` - 版本信息 DTO
   - `SystemVersionService` - 版本管理服务
   - `SystemVersionController` - REST API 控制器
   - 版本比较算法
   - 版本升级逻辑框架

2. **前端版本检查**
   - `versionChecker.ts` - 版本检查工具类
   - 自动检查（每 5 分钟）
   - 手动检查（设置页面）
   - 构建哈希检测
   - 智能更新通知

3. **API 接口**
   ```
   GET  /api/system/version       - 获取当前版本
   GET  /api/system/check-update  - 检查更新
   POST /api/system/upgrade        - 执行升级
   GET  /api/system/health         - 健康检查
   ```

4. **配置文件**
   - `application.yml`: `app.version` 和 `app.build-time`
   - `.env`: `VITE_APP_VERSION` 和 `VITE_BUILD_TIME`

### 使用方法

**发布新版本**：
1. 更新版本号（前后端配置文件）
2. 添加升级逻辑（如需要）
3. 更新更新日志
4. 构建和部署

**用户体验**：
- 自动检查：应用运行时定期检查
- 手动检查：设置页面点击"检查更新"
- 更新通知：发现新版本时弹出通知
- 一键更新：点击即可刷新到新版本

### 相关文件

**后端**：
- `src/main/java/com/flowbrain/viewx/pojo/dto/SystemVersionDTO.java`
- `src/main/java/com/flowbrain/viewx/service/SystemVersionService.java`
- `src/main/java/com/flowbrain/viewx/service/impl/SystemVersionServiceImpl.java`
- `src/main/java/com/flowbrain/viewx/controller/SystemVersionController.java`
- `src/main/resources/application.yml`

**前端**：
- `src/api/system.ts`
- `src/utils/versionChecker.ts`
- `src/views/Settings.vue`
- `src/App.vue`
- `.env.example`

**文档**：
- `docs/VERSION_MANAGEMENT.md`

---

## 总结

本次更新解决了以下核心问题：
1. ✅ 主题切换功能完全正常
2. ✅ 浅色模式显示优化
3. ✅ 导航高亮状态准确
4. ✅ GitHub OAuth 登录流程完善
5. ✅ 版本管理系统完整实现

所有功能已测试通过，可以正常使用。

### 注意事项

1. **主题切换**：首次使用时会从 localStorage 读取保存的主题偏好
2. **OAuth 登录**：确保后端配置了正确的 `viewx.frontend.url`
3. **版本检查**：需要在 `.env` 文件中配置 `VITE_APP_VERSION`
4. **安全配置**：`/system/**` 路径已设置为公开访问

### 后续优化建议

1. 考虑添加主题跟随系统设置的选项
2. OAuth 登录可以添加更多第三方平台（Google, GitLab 等）
3. 版本管理可以添加灰度发布功能
4. 可以添加更详细的更新日志展示界面
