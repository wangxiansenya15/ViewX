# è§†é¢‘å°é¢ä¸Šä¼ æµç¨‹è¯´æ˜

## ğŸ“‹ ä¸¤ç§å°é¢æ¥æº

ViewXæ”¯æŒä¸¤ç§æ–¹å¼ä¸ºè§†é¢‘æ·»åŠ å°é¢ï¼š

### 1. **ç”¨æˆ·è‡ªå®šä¹‰å°é¢** ğŸ‘¤
ç”¨æˆ·ä¸»åŠ¨ä¸Šä¼ è‡ªå·±é€‰æ‹©çš„å°é¢å›¾ç‰‡

### 2. **è‡ªåŠ¨æˆªå–å…³é”®å¸§** ğŸ¬
ç³»ç»Ÿä»è§†é¢‘ä¸­è‡ªåŠ¨æˆªå–ç¬¬1ç§’çš„ç”»é¢ä½œä¸ºå°é¢

---

## ğŸ”„ å®Œæ•´ä¸Šä¼ æµç¨‹

### æ–¹æ¡ˆAï¼šç”¨æˆ·ä¸Šä¼ è‡ªå®šä¹‰å°é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. ç”¨æˆ·é€‰æ‹©å°é¢å›¾ç‰‡
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /videos/upload/cover          â”‚
â”‚ uploadCoverImage(coverFile)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ å­˜å‚¨åˆ°: temp/covers/cover_{timestamp}.jpg
       â”‚         temp/covers/thumb_{timestamp}.jpg
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›: { coverUrl, thumbnailUrl }    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. å‰ç«¯ä¿å­˜è¿™ä¸¤ä¸ªURL
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /videos                        â”‚
â”‚ uploadVideo(videoFile, dto)         â”‚
â”‚   dto.coverUrl = ä¸Šä¸€æ­¥çš„coverUrl   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. åˆ›å»ºè§†é¢‘è®°å½•ï¼Œè·å–videoId
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨è§†é¢‘åˆ°:                         â”‚
â”‚ videos/{userId}/{videoId}/source.mp4â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. ä½¿ç”¨dto.getCoverUrl()
       â”‚    (ä¸´æ—¶ç›®å½•çš„å°é¢)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œæˆï¼è§†é¢‘ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å°é¢        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ¡ˆBï¼šè‡ªåŠ¨æˆªå–å…³é”®å¸§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. ç”¨æˆ·ä¸ä¸Šä¼ å°é¢
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /videos                        â”‚
â”‚ uploadVideo(videoFile, dto)         â”‚
â”‚   dto.coverUrl = null               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. åˆ›å»ºè§†é¢‘è®°å½•ï¼Œè·å–videoId
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨è§†é¢‘åˆ°:                         â”‚
â”‚ videos/{userId}/{videoId}/source.mp4â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. æ£€æµ‹åˆ°æ²¡æœ‰coverUrl
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VideoProcessingService              â”‚
â”‚ .generateThumbnail(videoFile, 1)    â”‚
â”‚                                     â”‚
â”‚ ä»è§†é¢‘ç¬¬1ç§’æˆªå–å…³é”®å¸§               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. ç”Ÿæˆå°é¢å’Œç¼©ç•¥å›¾
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨åˆ°:                             â”‚
â”‚ videos/{userId}/{videoId}/cover.jpg â”‚
â”‚ videos/{userId}/{videoId}/thumb.jpg â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œæˆï¼è§†é¢‘ä½¿ç”¨è‡ªåŠ¨æˆªå–çš„å°é¢        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ä»£ç å®ç°

### 1. ç”¨æˆ·è‡ªå®šä¹‰å°é¢ä¸Šä¼ 

**æ¥å£**: `POST /videos/upload/cover`

**å®ç°**: `VideoServiceImpl.uploadCoverImage()`

```java
@Override
public Result<CoverUploadVO> uploadCoverImage(MultipartFile file) {
    /**
     * ç”¨æˆ·è‡ªå®šä¹‰å°é¢ä¸Šä¼ æµç¨‹ï¼š
     * 1. å‰ç«¯è°ƒç”¨æ­¤æ¥å£é¢„ä¸Šä¼ å°é¢ â†’ è·å–coverUrlå’ŒthumbnailUrl
     * 2. å‰ç«¯è°ƒç”¨uploadVideoæ¥å£ï¼Œå°†coverUrlä¼ å…¥DTO
     * 3. åç«¯åœ¨uploadVideoä¸­ä½¿ç”¨dto.getCoverUrl()
     * 
     * æ³¨æ„ï¼šæ­¤æ—¶è¿˜æ²¡æœ‰videoIdï¼Œæ‰€ä»¥å­˜å‚¨åœ¨ä¸´æ—¶ç›®å½• temp/covers/
     * å¦‚æœç”¨æˆ·ä¸ä¸Šä¼ è‡ªå®šä¹‰å°é¢ï¼ŒuploadVideoä¼šè‡ªåŠ¨æˆªå–è§†é¢‘å…³é”®å¸§ä½œä¸ºå°é¢
     */
    
    String timestamp = String.valueOf(System.currentTimeMillis());
    String tempCoverPath = String.format("temp/covers/cover_%s.jpg", timestamp);
    String tempThumbPath = String.format("temp/covers/thumb_%s.jpg", timestamp);
    
    // å­˜å‚¨å°é¢å’Œç¼©ç•¥å›¾
    String coverUrl = storageStrategy.getFileUrl(storedCoverFilename);
    String thumbnailUrl = storageStrategy.getFileUrl(storedThumbnailFilename);
    
    return Result.success(new CoverUploadVO(coverUrl, thumbnailUrl));
}
```

**å­˜å‚¨è·¯å¾„**:
- å°é¢: `temp/covers/cover_1234567890.jpg`
- ç¼©ç•¥å›¾: `temp/covers/thumb_1234567890.jpg`

### 2. è§†é¢‘ä¸Šä¼ ï¼ˆå¤„ç†å°é¢ï¼‰

**æ¥å£**: `POST /videos`

**å®ç°**: `VideoServiceImpl.uploadVideo()`

```java
@Override
public Result<Long> uploadVideo(Long userId, MultipartFile videoFile, 
                                 MultipartFile coverFile, VideoUploadDTO dto) {
    // 1. åˆ›å»ºè§†é¢‘è®°å½•ï¼Œè·å–videoId
    Video video = new Video();
    videoMapper.insert(video);
    Long videoId = video.getId();
    
    // 2. ä¸Šä¼ è§†é¢‘æ–‡ä»¶
    String videoPath = FilePathUtil.generateVideoSourcePath(userId, videoId, ".mp4");
    // â†’ videos/123/456/source.mp4
    
    // 3. å¤„ç†å°é¢ï¼ˆä¸‰ç§æƒ…å†µï¼‰
    String coverUrl = null;
    String thumbnailUrl = null;
    
    if (coverFile != null && !coverFile.isEmpty()) {
        // æƒ…å†µ1: ç”¨æˆ·åœ¨ä¸Šä¼ è§†é¢‘æ—¶åŒæ—¶ä¸Šä¼ äº†å°é¢æ–‡ä»¶
        String coverPath = FilePathUtil.generateVideoCoverPath(userId, videoId, ".jpg");
        String thumbPath = FilePathUtil.generateVideoThumbnailPath(userId, videoId, ".jpg");
        // â†’ videos/123/456/cover.jpg
        // â†’ videos/123/456/thumb.jpg
        
    } else if (dto.getCoverUrl() != null && !dto.getCoverUrl().isEmpty()) {
        // æƒ…å†µ2: ç”¨æˆ·é¢„å…ˆä¸Šä¼ äº†è‡ªå®šä¹‰å°é¢ï¼ˆé€šè¿‡uploadCoverImageæ¥å£ï¼‰
        coverUrl = dto.getCoverUrl();
        thumbnailUrl = dto.getThumbnailUrl();
        // ä½¿ç”¨ä¸´æ—¶ç›®å½•çš„URL: temp/covers/cover_xxx.jpg
        
    } else {
        // æƒ…å†µ3: ç”¨æˆ·æ²¡æœ‰ä¸Šä¼ å°é¢ï¼Œè‡ªåŠ¨ä»è§†é¢‘æˆªå–å…³é”®å¸§
        File uploadedVideoFile = new File(storageStrategy.getStorageRoot() + "/" + storedFilename);
        String generatedCoverFilename = videoProcessingService.generateThumbnail(uploadedVideoFile, 1);
        // ç”Ÿæˆçš„å°é¢ä¼šè¢«ç§»åŠ¨åˆ°: videos/123/456/cover.jpg
    }
    
    // 4. æ›´æ–°è§†é¢‘è®°å½•
    video.setCoverUrl(coverUrl);
    video.setThumbnailUrl(thumbnailUrl);
    videoMapper.updateById(video);
    
    return Result.success(videoId);
}
```

---

## ğŸ“ æ–‡ä»¶å­˜å‚¨ä½ç½®

### ä¸´æ—¶å°é¢ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
```
temp/
â””â”€â”€ covers/
    â”œâ”€â”€ cover_1234567890.jpg      # ä¸´æ—¶å°é¢
    â””â”€â”€ thumb_1234567890.jpg      # ä¸´æ—¶ç¼©ç•¥å›¾
```

**ç‰¹ç‚¹**:
- âœ… è¿˜æ²¡æœ‰videoIdï¼Œä½¿ç”¨æ—¶é—´æˆ³å‘½å
- âœ… å‰ç«¯è·å–URLåä¼ ç»™uploadVideo
- âš ï¸ éœ€è¦å®šæœŸæ¸…ç†ï¼ˆå»ºè®®7å¤©ååˆ é™¤ï¼‰

### æ­£å¼å°é¢ï¼ˆè§†é¢‘å…³è”ï¼‰
```
videos/
â””â”€â”€ {userId}/
    â””â”€â”€ {videoId}/
        â”œâ”€â”€ source.mp4            # è§†é¢‘æºæ–‡ä»¶
        â”œâ”€â”€ cover.jpg             # å°é¢å›¾
        â””â”€â”€ thumb.jpg             # ç¼©ç•¥å›¾
```

**ç‰¹ç‚¹**:
- âœ… æœ‰æ˜ç¡®çš„videoId
- âœ… æ‰€æœ‰ç›¸å…³æ–‡ä»¶åœ¨åŒä¸€ç›®å½•
- âœ… åˆ é™¤è§†é¢‘æ—¶ä¸€èµ·åˆ é™¤

---

## ğŸ”„ ä¸´æ—¶æ–‡ä»¶æ¸…ç†

å»ºè®®æ·»åŠ å®šæ—¶ä»»åŠ¡æ¸…ç†ä¸´æ—¶å°é¢ï¼š

```java
@Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹
public void cleanTempCovers() {
    Path tempCoversDir = Paths.get(storageRoot, "temp/covers");
    
    try (Stream<Path> files = Files.walk(tempCoversDir)) {
        files.filter(Files::isRegularFile)
             .filter(path -> {
                 try {
                     FileTime fileTime = Files.getLastModifiedTime(path);
                     long daysSinceModified = ChronoUnit.DAYS.between(
                         fileTime.toInstant(), 
                         Instant.now()
                     );
                     return daysSinceModified > 7; // 7å¤©å‰çš„æ–‡ä»¶
                 } catch (IOException e) {
                     return false;
                 }
             })
             .forEach(path -> {
                 try {
                     Files.delete(path);
                     log.info("å·²åˆ é™¤ä¸´æ—¶å°é¢: {}", path);
                 } catch (IOException e) {
                     log.warn("åˆ é™¤ä¸´æ—¶å°é¢å¤±è´¥: {}", path, e);
                 }
             });
    } catch (IOException e) {
        log.error("æ¸…ç†ä¸´æ—¶å°é¢å¤±è´¥", e);
    }
}
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **ç”¨æˆ·è‡ªå®šä¹‰å°é¢** | ç²¾å‡†æ§åˆ¶ï¼Œç¾è§‚åº¦é«˜ | éœ€è¦é¢å¤–ä¸Šä¼ æ­¥éª¤ | ä¸“ä¸šåˆ›ä½œè€…ï¼Œé‡è§†å°é¢è´¨é‡ |
| **è‡ªåŠ¨æˆªå–å…³é”®å¸§** | æ“ä½œç®€å•ï¼Œä¸€æ­¥å®Œæˆ | å¯èƒ½ä¸å¤Ÿç¾è§‚ | å¿«é€Ÿå‘å¸ƒï¼Œå¯¹å°é¢è¦æ±‚ä¸é«˜ |

---

## âœ… æœ€ä½³å®è·µ

1. **å‰ç«¯æç¤º**: å»ºè®®ç”¨æˆ·ä¸Šä¼ è‡ªå®šä¹‰å°é¢ä»¥è·å¾—æ›´å¥½çš„å±•ç¤ºæ•ˆæœ
2. **é™çº§å¤„ç†**: å¦‚æœç”¨æˆ·ä¸ä¸Šä¼ ï¼Œè‡ªåŠ¨æˆªå–å…³é”®å¸§ä½œä¸ºå¤‡é€‰
3. **ä¸´æ—¶æ¸…ç†**: å®šæœŸæ¸…ç†7å¤©å‰çš„ä¸´æ—¶å°é¢æ–‡ä»¶
4. **é”™è¯¯å¤„ç†**: å°é¢ä¸Šä¼ å¤±è´¥ä¸å½±å“è§†é¢‘ä¸Šä¼ 
5. **æ€§èƒ½ä¼˜åŒ–**: ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨åŸå›¾ä½œä¸ºé™çº§æ–¹æ¡ˆ

---

**æœ€åæ›´æ–°**: 2025-12-24  
**ç‰ˆæœ¬**: v1.0
