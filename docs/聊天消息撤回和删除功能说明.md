# 聊天消息撤回和删除功能说明

## 功能概述

本次更新为聊天系统添加了消息撤回和删除功能，提升用户体验和隐私保护。

## 功能特性

### 1. 消息撤回功能

**限制条件：**
- 只能撤回自己发送的消息
- 消息发送后 2 分钟内可以撤回
- 已撤回的消息不能再次撤回

**实现方式：**
- 撤回后消息标记为 `is_recalled = true`
- 记录撤回时间 `recalled_at`
- 消息内容仍保留在数据库中，但前端显示为"已撤回"

**API 接口：**
- REST API：`PUT /messages/{messageId}/recall`

### 2. 消息删除功能

**权限：**
- 消息的发送者和接收者都可以删除消息
- 删除操作是软删除，数据库中标记 `is_deleted = true`

**实现方式：**
- 删除后的消息不会在聊天历史中显示
- 数据仍保留在数据库中，便于审计和恢复

**API 接口：**
- REST API：`DELETE /messages/{messageId}`

## 数据库变更

### 新增字段

在 `vx_messages` 表中添加以下字段：

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| is_recalled | BOOLEAN | FALSE | 是否已撤回 |
| is_deleted | BOOLEAN | FALSE | 是否已删除 |
| recalled_at | TIMESTAMP | NULL | 撤回时间 |

### 索引

- `idx_messages_is_deleted`：提高查询未删除消息的性能
- `idx_messages_is_recalled`：提高查询撤回状态的性能

## API 接口

### 1. 撤回消息

**WebSocket 消息：**
```javascript
// 发送撤回请求
stompClient.send("/app/chat.recall", {}, messageId);

// 接收撤回通知
stompClient.subscribe("/user/queue/recall", (message) => {
  const notification = JSON.parse(message.body);
  // notification = { messageId, userId, type: "MESSAGE_RECALLED" }
});
```

**业务逻辑：**
- 检查消息是否属于当前用户
- 检查消息是否在 2 分钟内
- 检查消息是否已经被撤回
- 更新消息状态为已撤回

### 2. 删除消息

**WebSocket 消息：**
```javascript
// 发送删除请求
stompClient.send("/app/chat.delete", {}, messageId);

// 接收删除通知
stompClient.subscribe("/user/queue/delete", (message) => {
  const notification = JSON.parse(message.body);
  // notification = { messageId, userId, type: "MESSAGE_DELETED" }
});
```

**业务逻辑：**
- 检查用户是否有权限删除（发送者或接收者）
- 软删除消息（标记 is_deleted = true）
- 删除后的消息不再出现在聊天历史中

## 前端集成指南

### 1. 消息展示

```typescript
// MessageVO 新增字段
interface MessageVO {
  id: number;
  senderId: number;
  receiverId: number;
  content: string;
  messageType: string;
  isRead: boolean;
  isRecalled: boolean;  // 新增
  recalledAt: string;   // 新增
  createdAt: string;
}

// 渲染消息
function renderMessage(message: MessageVO) {
  if (message.isRecalled) {
    return '<div class="recalled-message">消息已撤回</div>';
  }
  return `<div class="message">${message.content}</div>`;
}
```

### 2. 撤回按钮显示逻辑

```typescript
function canRecallMessage(message: MessageVO, currentUserId: number): boolean {
  // 只有发送者可以撤回
  if (message.senderId !== currentUserId) {
    return false;
  }
  
  // 已撤回的消息不能再撤回
  if (message.isRecalled) {
    return false;
  }
  
  // 检查是否在 2 分钟内
  const now = new Date();
  const createdAt = new Date(message.createdAt);
  const diffMinutes = (now.getTime() - createdAt.getTime()) / 1000 / 60;
  
  return diffMinutes <= 2;
}
```

### 3. WebSocket 集成示例

```typescript
// 连接 WebSocket
const stompClient = new Client({
  brokerURL: 'ws://localhost:8080/ws',
  // ...其他配置
});

// 订阅撤回通知
stompClient.subscribe('/user/queue/recall', (message) => {
  const notification = JSON.parse(message.body);
  // 更新 UI，将消息标记为已撤回
  updateMessageAsRecalled(notification.messageId);
});

// 订阅删除通知
stompClient.subscribe('/user/queue/delete', (message) => {
  const notification = JSON.parse(message.body);
  // 从 UI 中移除消息
  removeMessageFromUI(notification.messageId);
});

// 撤回消息
function recallMessage(messageId: number) {
  stompClient.publish({
    destination: '/app/chat.recall',
    body: messageId.toString()
  });
}

// 删除消息
function deleteMessage(messageId: number) {
  stompClient.publish({
    destination: '/app/chat.delete',
    body: messageId.toString()
  });
}
```

## 部署步骤

1. **执行数据库迁移**
   ```bash
   psql -U your_username -d viewx_db -f sql/add_message_recall_delete_fields.sql
   ```

2. **重启后端服务**
   ```bash
   mvn clean package
   java -jar target/viewx-backend.jar
   ```

3. **更新前端代码**
   - 更新 MessageVO 类型定义
   - 添加撤回和删除按钮
   - 实现 WebSocket 消息处理

## 注意事项

1. **时间限制**：撤回功能有 2 分钟的时间限制，这个限制在数据库层面通过 SQL 查询实现
2. **软删除**：删除操作是软删除，数据仍保留在数据库中
3. **权限控制**：撤回只能由发送者操作，删除可以由发送者或接收者操作
4. **实时通知**：撤回和删除操作会通过 WebSocket 实时通知相关用户
5. **历史消息**：查询聊天历史时会自动过滤已删除的消息

## 测试建议

### 单元测试
- 测试撤回消息的时间限制（2分钟内/超过2分钟）
- 测试撤回权限（只能撤回自己的消息）
- 测试删除权限（发送者和接收者都可以删除）
- 测试已撤回消息不能再次撤回

### 集成测试
- 测试 WebSocket 消息的发送和接收
- 测试多用户场景下的消息同步
- 测试撤回/删除后聊天历史的查询结果

### 性能测试
- 测试大量消息的撤回/删除操作
- 测试索引对查询性能的影响

## 未来优化方向

1. **批量操作**：支持批量删除消息
2. **撤回通知优化**：撤回时同时通知接收者
3. **恢复功能**：允许在一定时间内恢复已删除的消息
4. **审计日志**：记录所有撤回和删除操作的审计日志
5. **前端缓存**：优化前端消息缓存，减少不必要的网络请求
