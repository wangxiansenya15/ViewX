# 智能风险评估与人机验证系统

## 概述

本系统实现了基于多维度风险评估的智能人机验证机制，根据用户行为和环境特征动态调整验证策略。

## 风险等级定义

### 1. 低风险（直接放行）
**特征：**
- 已登录用户正常操作
- 常用设备/IP（30天内登录过）
- 正常时间访问（8:00-22:00）
- 无登录失败记录
- 正常的 User-Agent

**处理策略：** 跳过人机验证，直接进行账号密码验证

### 2. 中风险（轻度验证）
**特征：**
- 新设备登录
- 非高峰时段访问
- 首次提交表单（注册、首次登录）
- 有少量登录失败记录（1-2次）

**处理策略：** 要求完成人机验证（Cloudflare Turnstile 或滑块验证）

### 3. 高风险（严格验证）
**特征：**
- 多次登录失败（≥3次）
- 异常请求频率（>10次/分钟）
- 代理/VPN访问
- 可疑User-Agent（bot、crawler等关键词）

**处理策略：** 强制要求完成人机验证，验证失败直接拒绝

## 风险评分机制

系统采用累积评分模型，各维度权重如下：

| 风险因素 | 分数 | 说明 |
|---------|------|------|
| 登录失败次数≥3 | 直接判定高风险 | 立即触发严格验证 |
| 登录失败次数1-2 | +20 | 增加风险分数 |
| 请求频率>10/分钟 | +30 | 可能的暴力破解 |
| 新设备/IP | +25 | 首次访问 |
| 非高峰时段 | +10 | 22:00-8:00 |
| 可疑User-Agent | +25 | 包含bot/crawler等 |
| 代理/VPN | +30 | 隐藏真实IP |

**风险等级判定：**
- 总分 ≥ 50：高风险
- 总分 20-49：中风险
- 总分 < 20：低风险

## 技术实现

### 核心组件

1. **RiskLevel.java** - 风险等级枚举
2. **RiskAssessmentService.java** - 风险评估服务
3. **HttpRequestUtils.java** - HTTP请求工具类
4. **AuthenticationService.java** - 认证服务（集成风险评估）

### 数据存储

#### Redis（临时缓存）

```
# 登录失败记录
security:login:failure:{username}:{ip} -> 失败次数（30分钟过期）

# 请求频率限制
security:request:rate:{ip} -> 请求次数（1分钟过期）

# 已知设备记录
security:known:device:{username}:{ip} -> "1"（30天过期）
```

#### MySQL（持久化审计）

**login_audit 表** - 登录审计记录
- 记录所有登录尝试（成功/失败）
- 包含风险评估结果
- 记录人机验证状态
- 支持按用户、IP、时间等多维度查询

**security_event 表** - 安全事件记录
- 记录各类安全事件（多次失败、异常频率、可疑UA等）
- 支持事件严重程度分级
- 提供事件处理状态跟踪
- 用于威胁分析和告警

**审计数据用途：**
1. **安全分析**：识别攻击模式和异常行为
2. **合规要求**：满足安全审计和日志留存要求
3. **用户行为分析**：了解用户登录习惯
4. **事件溯源**：安全事件发生后的调查取证

### 工作流程

```
1. 用户发起登录请求
   ↓
2. 提取客户端信息（IP、User-Agent）
   ↓
3. 风险评估（多维度打分）
   ↓
4. 判定风险等级
   ├─ 低风险 → 跳过验证
   ├─ 中风险 → 要求验证
   └─ 高风险 → 强制验证
   ↓
5. 执行账号密码验证
   ↓
6. 登录成功/失败处理
   ├─ 成功 → 清除失败记录 + 记录为已知设备
   └─ 失败 → 增加失败计数
```

## 配置说明

### application.yml

```yaml
captcha:
  enabled: true
  type: turnstile  # 或 slider
  site-key: your-site-key
  secret-key: your-secret-key
```

### 可调参数

在 `RiskAssessmentService.java` 中：

```java
// 高峰时段定义
private static final LocalTime PEAK_START = LocalTime.of(8, 0);
private static final LocalTime PEAK_END = LocalTime.of(22, 0);

// 登录失败次数阈值
private static final int LOGIN_FAILURE_THRESHOLD = 3;

// 请求频率阈值（每分钟）
private static final int REQUEST_RATE_THRESHOLD = 10;
```

## 安全优势

1. **智能化**：根据实际风险动态调整验证策略
2. **用户友好**：低风险用户无需额外验证
3. **防护有效**：高风险行为强制验证
4. **可追溯**：完整的风险评估日志
5. **可扩展**：易于添加新的风险维度

## 日志示例

```
INFO  - 登录请求 - 用户名: alice, IP: 192.168.1.100, UA: Mozilla/5.0...
INFO  - 检测到新设备登录 - 用户名: alice, IP: 192.168.1.100
INFO  - 风险评估结果: 中风险 (分数: 25)
INFO  - 风险评估完成 - 用户名: alice, 风险等级: 中风险
INFO  - 人机验证通过 - 用户名: alice, 风险等级: 中风险
INFO  - 用户凭证验证成功
INFO  - 记录已知设备 - 用户名: alice, IP: 192.168.1.100
INFO  - 登录成功，返回200 OK响应
```

## 未来优化方向

1. **集成第三方IP信誉库**（如 IPQualityScore、MaxMind）
2. **机器学习模型**：基于历史数据训练风险预测模型
3. **设备指纹识别**：更精确的设备识别
4. **地理位置异常检测**：检测IP地理位置突变
5. **行为分析**：鼠标轨迹、键盘输入模式等

## 维护建议

1. **定期审查风险阈值**：根据实际攻击情况调整
2. **监控误判率**：避免过度拦截正常用户
3. **清理过期数据**：Redis自动过期机制
4. **日志分析**：定期分析风险评估日志，发现新的攻击模式
