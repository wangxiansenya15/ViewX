# 视频审核功能优化总结

## 🎯 已实现的优化

### 1. 管理员视频自动审核通过
**文件**: `VideoServiceImpl.java`

**功能**: 管理员和超级管理员上传的视频自动通过审核，无需等待人工审核。

**实现逻辑**:
```java
// 根据用户角色设置审核状态
User uploader = userMapper.selectById(userId);
if (uploader != null && 
    (uploader.getRole() == Role.ADMIN || 
     uploader.getRole() == Role.SUPER_ADMIN)) {
    video.setStatus("APPROVED"); // 管理员视频自动通过
    video.setPublishedAt(LocalDateTime.now()); // 立即发布
} else {
    video.setStatus("PENDING"); // 普通用户和审核员需要审核
}
```

**影响**:
- ✅ 管理员和超级管理员：视频立即发布，状态为 `APPROVED`
- ⏳ 普通用户和审核员：视频需要审核，状态为 `PENDING`

---

### 2. 审核通过后实时更新推荐列表
**文件**: `AdminServiceImpl.java`

**问题**: 视频审核通过后，虽然更新了 Redis trending 分数，但前端分页缓存未失效，导致用户需要手动刷新才能看到新视频。

**解决方案**:
1. **更新 Redis trending 分数**: 审核通过时调用 `recommendService.updateVideoScore(videoId)`
2. **清除分页缓存**: 调用 `clearTrendingCache()` 删除所有分页缓存

**实现代码**:
```java
@Override
@Transactional
public Result<String> approveVideo(Long videoId) {
    // ... 更新视频状态 ...
    
    // 更新 Redis 推荐分数
    try {
        recommendService.updateVideoScore(videoId);
        log.info("已更新视频 {} 的推荐分数", videoId);
    } catch (Exception e) {
        log.warn("更新推荐分数失败，不影响审核: {}", e.getMessage());
    }

    // 清除分页缓存，确保前端能立即看到新视频
    clearTrendingCache();
    
    // ... 发送通知 ...
}

private void clearTrendingCache() {
    try {
        // 使用通配符删除所有 trending 分页缓存
        String pattern = RedisKeyConstants.Recommend.getTrendingKey() + ":page:*";
        Set<String> keys = redisTemplate.keys(pattern);
        
        if (keys != null && !keys.isEmpty()) {
            redisTemplate.delete(keys);
            log.info("已清除 {} 个 trending 缓存键", keys.size());
        }
    } catch (Exception e) {
        log.warn("清除 trending 缓存失败: {}", e.getMessage());
    }
}
```

**效果**:
- ✅ 审核通过后，前端**立即**能看到新视频（无需手动刷新）
- ✅ 新视频会出现在推荐列表的合适位置（根据分数排序）
- ✅ 缓存失效后，下次请求会重新从数据库查询最新数据

---

## 📊 完整的视频审核流程

### 普通用户上传视频
```
1. 用户上传视频
   ↓
2. 视频状态设为 PENDING
   ↓
3. 管理员在审核页面查看
   ↓
4. 管理员审核：
   - 通过 → 状态改为 APPROVED
          → 更新 Redis trending 分数
          → 清除分页缓存
          → 发送通知给用户
          → 前端立即显示新视频
   
   - 拒绝 → 状态改为 REJECTED
          → 发送通知给用户（含拒绝原因）
```

### 管理员上传视频
```
1. 管理员上传视频
   ↓
2. 检测到用户角色为 ADMIN/SUPER_ADMIN
   ↓
3. 视频状态直接设为 APPROVED
   ↓
4. 立即发布（设置 publishedAt）
   ↓
5. 更新 Redis 推荐分数
   ↓
6. 前端立即可见
```

---

## 🔧 技术细节

### Redis 缓存策略

#### 1. Trending 分数（ZSet）
- **Key**: `recommend:trending`
- **Value**: 视频 ID
- **Score**: 计算得分（基于播放量、点赞数、评论数、时间衰减）
- **更新时机**: 
  - 视频上传时（管理员自动通过）
  - 视频审核通过时
  - 视频互动时（点赞、评论等）

#### 2. 分页缓存（String）
- **Key**: `recommend:trending:page:{page}:size:{size}`
- **Value**: 视频 ID 列表
- **TTL**: 5 分钟
- **清除时机**: 
  - 视频审核通过时（清除所有分页缓存）
  - 自动过期（5分钟后）

### 缓存清除机制

使用通配符模式删除所有分页缓存：
```java
String pattern = "recommend:trending:page:*";
Set<String> keys = redisTemplate.keys(pattern);
redisTemplate.delete(keys);
```

**优点**:
- ✅ 简单高效
- ✅ 确保所有分页都能看到最新数据
- ✅ 不影响 trending 分数的 ZSet

**注意事项**:
- ⚠️ `keys()` 命令在生产环境中可能影响性能
- 💡 未来可以考虑使用 `scan()` 命令替代
- 💡 或者使用发布/订阅模式通知前端刷新

---

## 🎨 前端体验优化

### 审核通过后的用户体验

#### 之前的问题:
```
管理员审核通过 → Redis 更新 → 前端仍显示旧数据（缓存未失效）
用户需要：手动刷新页面 或 等待5分钟缓存过期
```

#### 现在的体验:
```
管理员审核通过 → Redis 更新 + 清除缓存 → 前端立即显示新视频
用户体验：无感知，自动更新
```

### 实时性保证

1. **审核通过**: 立即清除缓存 → 下次请求获取最新数据
2. **自动审核**: 管理员上传 → 直接 APPROVED → 立即可见
3. **分数更新**: 实时更新 trending 分数 → 正确排序

---

## 📝 配置说明

### 角色权限

| 角色 | 上传视频 | 审核状态 | 审核权限 |
|------|---------|---------|---------|
| SUPER_ADMIN | ✅ | 自动通过 | ✅ 可审核 |
| ADMIN | ✅ | 自动通过 | ✅ 可审核 |
| REVIEWER | ✅ | 需要审核 | ✅ 可审核 |
| USER | ✅ | 需要审核 | ❌ 不可审核 |

### 视频状态

| 状态 | 说明 | 可见性 |
|------|------|--------|
| PENDING | 待审核 | 仅上传者和管理员可见 |
| APPROVED | 已通过 | 所有用户可见 |
| REJECTED | 已拒绝 | 仅上传者和管理员可见 |

---

## 🚀 测试建议

### 1. 管理员自动审核测试
```
1. 使用管理员账号登录
2. 上传视频
3. 验证视频状态为 APPROVED
4. 验证视频立即出现在首页推荐列表
```

### 2. 审核通过实时更新测试
```
1. 使用普通用户账号上传视频
2. 验证视频状态为 PENDING
3. 验证首页不显示该视频
4. 使用管理员账号审核通过
5. 刷新首页，验证视频立即显示
6. 检查 Redis 日志，确认缓存已清除
```

### 3. 缓存清除测试
```
1. 打开首页，加载视频列表（触发缓存）
2. 审核通过一个视频
3. 检查后端日志：
   - "已更新视频 X 的推荐分数"
   - "已清除 N 个 trending 缓存键"
4. 再次请求首页，验证返回最新数据
```

---

## 🐛 已知问题和改进方向

### 当前实现的局限性

1. **`keys()` 命令性能**
   - 问题：在大量缓存键时可能阻塞 Redis
   - 改进：使用 `scan()` 命令替代
   - 优先级：中（生产环境建议优化）

2. **全量清除缓存**
   - 问题：清除所有分页缓存，可能导致短暂的缓存雪崩
   - 改进：只清除受影响的分页
   - 优先级：低（当前流量下影响不大）

3. **前端轮询**
   - 问题：前端需要定期刷新才能看到更新
   - 改进：使用 WebSocket 推送更新通知
   - 优先级：低（用户体验已可接受）

### 未来优化方向

1. **智能缓存失效**
   ```java
   // 只清除可能包含新视频的分页
   // 例如：如果新视频分数很高，只清除前几页
   ```

2. **WebSocket 实时推送**
   ```javascript
   // 前端监听审核通过事件
   socket.on('video:approved', (videoId) => {
       // 自动刷新列表或插入新视频
   })
   ```

3. **分布式缓存失效**
   ```java
   // 使用 Redis 发布/订阅通知所有服务器节点
   redisTemplate.convertAndSend("cache:invalidate", "trending");
   ```

---

## 📚 相关文档

- [视频审核功能实现总结.md](./视频审核功能实现总结.md) - 基础功能实现
- [Redis 缓存策略](../docs/redis-cache-strategy.md) - 缓存设计文档
- [角色权限管理](../docs/role-permissions.md) - 权限配置说明

---

## ✅ 总结

本次优化实现了两个重要功能：

1. **管理员视频自动审核** - 提升管理员发布效率
2. **审核通过实时更新** - 提升用户体验，无需手动刷新

这些优化确保了：
- ✅ 管理员可以快速发布内容
- ✅ 用户能立即看到新审核通过的视频
- ✅ 系统保持高性能和良好的用户体验
