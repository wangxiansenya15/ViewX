# 视频自动封面提取功能说明

## 功能概述
当用户上传视频时，如果没有提供封面图，系统会自动使用 FFmpeg 从视频的第1秒提取关键帧作为封面图和缩略图。

## 实现逻辑

### 1. 封面处理流程
视频上传时，系统按以下优先级处理封面：

```
1. 用户上传了封面图 (coverFile != null)
   ↓
   使用用户上传的封面图
   
2. DTO中包含coverUrl (dto.getCoverUrl() != null)
   ↓
   使用DTO中的封面URL（兼容旧逻辑）
   
3. 都没有
   ↓
   自动从视频提取关键帧作为封面
```

### 2. 自动提取封面的步骤

#### 步骤 1: 从视频提取关键帧
```java
// 从视频第1秒提取关键帧
String generatedCoverFilename = videoProcessingService.generateThumbnail(uploadedVideoFile, 1);
```

这会调用 FFmpeg 命令：
```bash
docker exec viewx-ffmpeg ffmpeg -ss 1 -i /workdir/video.mp4 -vframes 1 -q:v 2 -y /workdir/video_thumb_1.jpg
```

#### 步骤 2: 生成缩略图
从提取的封面图生成 320x180 的缩略图：
```java
byte[] thumbnailBytes = videoProcessingService.generateThumbnailFromCover(tempCoverFile);
```

#### 步骤 3: 保存文件
- 封面图保存在：`uploads/videos/[filename]_thumb_1.jpg`
- 缩略图保存在：`uploads/videos/thumbnails/thumb_[userId]_[timestamp].jpg`

## 代码修改

### 1. VideoServiceImpl.java
在 `uploadVideo()` 方法中添加了自动提取封面的逻辑：

```java
} else {
    // 用户既没有上传封面，也没有提供coverUrl，自动从视频提取关键帧
    log.info("用户未上传封面图，尝试从视频中提取关键帧作为封面");
    try {
        // 获取已上传的视频文件
        java.io.File uploadedVideoFile = new java.io.File(
                storageStrategy.getStorageRoot() + "/" + storedFilename);
        
        if (uploadedVideoFile.exists()) {
            // 从视频第1秒提取关键帧作为封面
            String generatedCoverFilename = videoProcessingService.generateThumbnail(uploadedVideoFile, 1);
            
            // ... 生成缩略图并保存
        }
    } catch (Exception e) {
        log.error("从视频提取封面失败，视频将没有封面图", e);
        // 提取失败不影响视频上传
    }
}
```

### 2. LocalStorageStrategy.java
添加了 `getStorageRoot()` 方法以支持获取存储根目录：

```java
public String getStorageRoot() {
    return storageLocation.toString();
}
```

## 使用示例

### 场景 1: 用户上传视频和封面
```java
// 前端上传
POST /api/videos/upload
- videoFile: video.mp4
- coverFile: cover.jpg
- title: "我的视频"

// 结果：使用用户上传的 cover.jpg
```

### 场景 2: 用户只上传视频
```java
// 前端上传
POST /api/videos/upload
- videoFile: video.mp4
- title: "我的视频"

// 结果：自动从 video.mp4 的第1秒提取封面
```

### 场景 3: 提取失败的降级处理
如果 FFmpeg 提取失败（例如视频损坏、FFmpeg 服务不可用），系统会：
1. 记录错误日志
2. 继续完成视频上传
3. 视频将没有封面图（coverUrl 和 thumbnailUrl 为 null）

## 注意事项

### 1. 性能考虑
- FFmpeg 提取关键帧是 CPU 密集型操作
- 建议在生产环境中：
  - 使用异步任务队列处理
  - 限制并发提取数量
  - 监控 FFmpeg 容器的资源使用

### 2. 提取时间点
当前设置为第1秒（`timestamp = 1`），可以根据需要调整：
- 第0秒：可能是黑屏
- 第1秒：通常已经有画面
- 视频中间：需要先获取视频时长

### 3. 文件存储
- 提取的封面图存储在 `uploads/videos/` 目录
- 与视频文件在同一目录，便于管理
- 文件名格式：`[原视频名]_thumb_1.jpg`

### 4. 错误处理
```java
try {
    // 提取封面
} catch (Exception e) {
    log.error("从视频提取封面失败，视频将没有封面图", e);
    // 提取失败不影响视频上传，只是没有封面而已
}
```

## 扩展功能建议

### 1. 智能关键帧选择
可以提取多个时间点的帧，选择最佳的一帧：
```java
// 提取 1秒、3秒、5秒 的帧
// 使用图像分析选择最清晰、最有代表性的一帧
```

### 2. 异步处理
```java
@Async
public CompletableFuture<String> extractCoverAsync(File videoFile) {
    // 异步提取封面
}
```

### 3. 缓存机制
```java
// 如果同一视频已经提取过封面，直接复用
```

### 4. 用户自定义提取时间点
```java
// 允许用户指定从第几秒提取封面
POST /api/videos/upload
- videoFile: video.mp4
- coverTimestamp: 5  // 从第5秒提取
```

## 测试建议

### 1. 单元测试
```java
@Test
public void testAutoExtractCover() {
    // 测试自动提取封面功能
}
```

### 2. 集成测试
```bash
# 上传视频（不带封面）
curl -X POST http://localhost:8080/api/videos/upload \
  -F "videoFile=@test.mp4" \
  -F "title=测试视频"

# 验证返回的 coverUrl 和 thumbnailUrl 不为空
```

### 3. 性能测试
```bash
# 测试并发上传多个视频
# 监控 FFmpeg 容器的 CPU 和内存使用
docker stats viewx-ffmpeg
```

## 日志示例

### 成功提取
```
2025-12-17 23:00:00 INFO  - 用户未上传封面图，尝试从视频中提取关键帧作为封面
2025-12-17 23:00:01 INFO  - 成功生成视频缩略图: video_123_1734451200000_thumb_1.jpg
2025-12-17 23:00:02 INFO  - 从视频提取的封面成功生成缩略图: http://localhost/viewx/videos/thumbnails/thumb_1_1734451200000.jpg
2025-12-17 23:00:02 INFO  - 成功从视频提取封面: coverUrl=http://localhost/viewx/videos/video_123_1734451200000_thumb_1.jpg, thumbnailUrl=http://localhost/viewx/videos/thumbnails/thumb_1_1734451200000.jpg
```

### 提取失败
```
2025-12-17 23:00:00 INFO  - 用户未上传封面图，尝试从视频中提取关键帧作为封面
2025-12-17 23:00:01 ERROR - FFmpeg 截图失败，退出码: 1, 输出: [error details]
2025-12-17 23:00:01 ERROR - 从视频提取封面失败，视频将没有封面图
```

## 相关文件

- `VideoServiceImpl.java` - 视频上传逻辑
- `VideoProcessingServiceImpl.java` - FFmpeg 处理服务
- `LocalStorageStrategy.java` - 本地存储策略
- `docker-compose.yml` - FFmpeg 容器配置

## 总结

这个功能提升了用户体验，即使用户忘记上传封面图，系统也能自动生成一个合理的封面。同时，通过完善的错误处理机制，确保即使自动提取失败也不会影响视频上传流程。
