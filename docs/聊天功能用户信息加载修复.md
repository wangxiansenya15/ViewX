# 聊天功能用户信息加载问题修复

## 问题描述
用户在尝试发送聊天消息时，收到错误提示："用户信息未加载，请重新登录"

## 根本原因分析

### 问题1: 登录时未保存用户信息
在 `Login.vue` 中，登录成功后只保存了 token，但没有将用户信息保存到 `userStore` 中。

### 问题2: 应用启动时未加载用户信息
在 `App.vue` 的 `checkAuth` 函数中，只检查了 token 是否存在，但没有从服务器获取用户信息。

### 问题3: 聊天功能缺少空值检查
在 `chat.ts` 的 `sendMessage` 函数中，直接使用了 `userStore.userInfo!.id`，没有检查 `userInfo` 是否为 null。

## 修复方案

### 1. Login.vue - 登录时保存用户信息
```typescript
// 导入 useUserStore
import { useUserStore } from '@/stores'

// 在登录成功后保存用户信息
const userStore = useUserStore()
userStore.setToken(res.token)

if (res.userInfo) {
  userStore.setUserInfo({
    id: res.userInfo.id,
    username: res.userInfo.username,
    nickname: res.userInfo.username,
    avatar: res.userInfo.avatar || ''
  })
}
```

### 2. App.vue - 应用启动时自动加载用户信息
```typescript
// 导入 useUserStore
import { useUserStore } from '@/stores'

const checkAuth = async () => {
  const token = localStorage.getItem('token')
  if (token) {
    const userStore = useUserStore()
    
    // 如果 userInfo 已经存在，直接标记为已登录
    if (userStore.userInfo) {
      isLoggedIn.value = true
      return
    }
    
    // 否则，从服务器获取用户信息
    try {
      const { authApi } = await import('@/api')
      const userInfo = await authApi.me()
      
      // 保存用户信息（注意字段名映射）
      userStore.setUserInfo({
        id: userInfo.userId,
        username: userInfo.username,
        nickname: userInfo.nickname || userInfo.username,
        avatar: userInfo.avatarUrl || ''
      })
      
      isLoggedIn.value = true
    } catch (error) {
      console.error('获取用户信息失败:', error)
      handleLogout()
    }
  }
}
```

### 3. chat.ts - 添加空值检查
```typescript
async function sendMessage(receiverId: number, content: string) {
  // ... 其他检查 ...
  
  // 检查用户信息是否存在
  if (!userStore.userInfo) {
    ElMessage.error('用户信息未加载，请重新登录')
    return false
  }
  
  // 安全访问用户信息（不使用非空断言）
  const tempMessage: MessageVO = {
    id: Date.now(),
    senderId: userStore.userInfo.id,
    senderUsername: userStore.userInfo.username,
    // ...
  }
}
```

### 4. API 定义修正
```typescript
// index.ts
export const authApi = {
  me() {
    return request.get<UserProfileVO>('/user/profile/me')
  }
}
```

## 字段映射说明

后端 `UserProfileVO` 与前端 `UserInfo` 的字段映射：

| 后端字段 (UserProfileVO) | 前端字段 (UserInfo) | 说明 |
|-------------------------|-------------------|------|
| userId | id | 用户ID |
| username | username | 用户名 |
| nickname | nickname | 昵称 |
| avatarUrl | avatar | 头像URL |

## 测试步骤

### 场景1: 新用户登录
1. 清除浏览器所有数据（localStorage, cookies等）
2. 访问登录页面
3. 输入用户名和密码登录
4. 打开浏览器开发者工具 -> Application -> Local Storage
5. 验证是否同时保存了 `token` 和 `userInfo`
6. 打开聊天页面，尝试发送消息
7. **预期结果**: 消息发送成功

### 场景2: 已登录用户刷新页面
1. 在已登录状态下刷新页面
2. 打开浏览器开发者工具 -> Network
3. 查看是否调用了 `/user/profile/me` 接口
4. 打开聊天页面，尝试发送消息
5. **预期结果**: 消息发送成功

### 场景3: Token 失效
1. 手动修改 localStorage 中的 token 为无效值
2. 刷新页面
3. **预期结果**: 自动退出登录，跳转到首页

## 相关文件

### 前端
- `d:\Projects\ViewX\ViewX-frontend\src\views\Login.vue` - 登录页面
- `d:\Projects\ViewX\ViewX-frontend\src\App.vue` - 应用入口
- `d:\Projects\ViewX\ViewX-frontend\src\stores\chat.ts` - 聊天状态管理
- `d:\Projects\ViewX\ViewX-frontend\src\stores\user.ts` - 用户状态管理
- `d:\Projects\ViewX\ViewX-frontend\src\api\index.ts` - API 定义

### 后端
- `d:\Projects\ViewX\src\main\java\com\flowbrain\viewx\controller\ProfileController.java` - 用户资料控制器
- `d:\Projects\ViewX\src\main\java\com\flowbrain\viewx\pojo\vo\UserProfileVO.java` - 用户资料 VO

## 注意事项

1. **刷新页面后测试**: 修复后，建议刷新页面（Ctrl+R 或 F5）以确保新代码生效
2. **清除缓存**: 如果问题仍然存在，尝试清除浏览器缓存或使用无痕模式
3. **检查 Network**: 使用浏览器开发者工具的 Network 标签，确认 API 调用是否成功
4. **查看 Console**: 检查浏览器控制台是否有错误信息

## 后续优化建议

1. **Token 刷新机制**: 实现 token 自动刷新，避免用户频繁重新登录
2. **用户信息缓存**: 考虑在 localStorage 中缓存用户基本信息，减少 API 调用
3. **错误处理**: 增强错误处理，为用户提供更友好的错误提示
4. **加载状态**: 在加载用户信息时显示加载动画，提升用户体验
