# 用户状态验证修复说明

## 问题描述
用户被锁定、封禁、过期后仍然可以正常登录

## 根本原因
在 `SecurityConfig.java` 的 `userDetailsService` 方法中,只检查了用户是否存在和角色是否存在,但没有将用户的状态字段(enabled, accountNonExpired, accountNonLocked, credentialsNonExpired)传递给 Spring Security 的 `UserDetails` 对象。

## 修复内容

### 1. SecurityConfig.java
在 `userDetailsService` Bean 中添加了账户状态字段的设置:

```java
return org.springframework.security.core.userdetails.User
    .withUsername(user.getUsername())
    .password(user.getPassword())
    .roles(new String[] { (user.getRole().name()) })
    // 设置账户状态字段，这些字段控制用户是否能够登录
    .disabled(!user.isEnabled()) // 账户是否被禁用
    .accountExpired(!user.isAccountNonExpired()) // 账户是否过期
    .accountLocked(!user.isAccountNonLocked()) // 账户是否被锁定
    .credentialsExpired(!user.isCredentialsNonExpired()) // 凭证是否过期
    .build();
```

### 2. AuthenticationService.java
增强了异常处理,为不同的账户状态问题提供明确的错误信息:

- `DisabledException`: 账户已被禁用
- `LockedException`: 账户已被锁定
- `AccountExpiredException`: 账户已过期
- `CredentialsExpiredException`: 凭证已过期
- `BadCredentialsException`: 用户名或密码错误

## 测试步骤

### 测试1: 锁定账户
1. 使用管理员账户登录系统
2. 在用户管理页面,找到一个测试用户
3. 将该用户的状态设置为"锁定"(account_non_locked = false)
4. 退出登录
5. 尝试使用被锁定的用户登录
6. **预期结果**: 登录失败,提示"账户已被锁定，请联系管理员"

### 测试2: 禁用账户
1. 使用管理员账户登录系统
2. 在用户管理页面,找到一个测试用户
3. 将该用户的状态设置为"禁用"(enabled = false)
4. 退出登录
5. 尝试使用被禁用的用户登录
6. **预期结果**: 登录失败,提示"账户已被禁用，请联系管理员"

### 测试3: 过期账户
1. 使用管理员账户登录系统
2. 在用户管理页面,找到一个测试用户
3. 将该用户的状态设置为"过期"(account_non_expired = false)
4. 退出登录
5. 尝试使用过期的用户登录
6. **预期结果**: 登录失败,提示"账户已过期，请联系管理员"

### 测试4: 凭证过期
1. 使用管理员账户登录系统
2. 在用户管理页面,找到一个测试用户
3. 将该用户的状态设置为"凭证过期"(credentials_non_expired = false)
4. 退出登录
5. 尝试使用凭证过期的用户登录
6. **预期结果**: 登录失败,提示"凭证已过期，请重置密码"

### 测试5: 正常账户
1. 确保测试用户的所有状态字段都是正常的:
   - enabled = true
   - account_non_expired = true
   - account_non_locked = true
   - credentials_non_expired = true
2. 尝试登录
3. **预期结果**: 登录成功

## 数据库字段说明

在 `vx_users` 表中,以下字段控制用户状态:

| 字段名 | 类型 | 说明 | 正常值 |
|--------|------|------|--------|
| enabled | boolean | 账户是否启用 | true |
| account_non_expired | boolean | 账户是否未过期 | true |
| account_non_locked | boolean | 账户是否未锁定 | true |
| credentials_non_expired | boolean | 凭证是否未过期 | true |

**注意**: 这些字段的命名是"非XX"的形式,所以:
- `true` 表示正常状态(未锁定、未过期等)
- `false` 表示异常状态(已锁定、已过期等)

## 相关代码文件

1. `SecurityConfig.java` - Spring Security 配置,UserDetailsService Bean
2. `AuthenticationService.java` - 认证服务,处理登录逻辑和异常
3. `User.java` - 用户实体类,包含状态字段
4. `UserStatus.java` - 用户状态枚举类
5. `UserService.java` - 用户服务,包含状态更新方法

## 安全建议

1. **日志记录**: 所有登录失败的尝试都会被记录,包括失败原因
2. **错误信息**: 向用户提供明确但不泄露敏感信息的错误提示
3. **状态管理**: 管理员应定期审查被锁定/禁用的账户
4. **自动锁定**: 系统已实现登录失败5次自动锁定功能(见 `UserService.handleLoginFailure`)
