# 问题修复总结

## 问题1: 用户状态验证失败
**报告时间**: 2025-12-17 17:36

### 问题描述
用户被锁定、封禁、过期后仍然可以正常登录

### 根本原因
在 `SecurityConfig.java` 的 `userDetailsService` 方法中,虽然从数据库加载了用户信息,但没有将用户的账户状态字段传递给 Spring Security 的 `UserDetails` 对象。Spring Security 依赖这些字段来判断用户是否可以登录。

### 修复内容

#### 1. SecurityConfig.java
在 `userDetailsService` Bean 中添加了账户状态字段的设置:

```java
return org.springframework.security.core.userdetails.User
    .withUsername(user.getUsername())
    .password(user.getPassword())
    .roles(new String[] { (user.getRole().name()) })
    // 设置账户状态字段，这些字段控制用户是否能够登录
    .disabled(!user.isEnabled()) // 账户是否被禁用
    .accountExpired(!user.isAccountNonExpired()) // 账户是否过期
    .accountLocked(!user.isAccountNonLocked()) // 账户是否被锁定
    .credentialsExpired(!user.isCredentialsNonExpired()) // 凭证是否过期
    .build();
```

#### 2. AuthenticationService.java
增强了异常处理,为不同的账户状态问题提供明确的错误信息:

- `DisabledException`: 账户已被禁用,请联系管理员
- `LockedException`: 账户已被锁定,请联系管理员
- `AccountExpiredException`: 账户已过期,请联系管理员
- `CredentialsExpiredException`: 凭证已过期,请重置密码
- `BadCredentialsException`: 用户名或密码错误

### 影响范围
- 所有用户登录流程
- 管理员用户状态管理功能

---

## 问题2: 聊天功能发送消息失败
**报告时间**: 2025-12-17 17:50

### 错误信息
```
TypeError: Cannot read properties of null (reading 'id')
    at Proxy.sendMessage (chat.ts:165:47)
```

### 根本原因
1. 登录成功后,只保存了 token,但没有保存用户信息到 `userStore`
2. 聊天功能在发送消息时需要访问 `userStore.userInfo.id`,但 `userInfo` 为 `null`

### 修复内容

#### 1. chat.ts
在 `sendMessage` 函数中添加了对 `userInfo` 的 null 检查:

```typescript
// 检查用户信息是否存在
if (!userStore.userInfo) {
    ElMessage.error('用户信息未加载，请重新登录')
    return false
}
```

并移除了所有的非空断言操作符 (`!`),改为在检查后安全访问。

#### 2. Login.vue
修复了登录成功后的用户信息保存逻辑:

```typescript
// 保存用户信息到 store
const userStore = useUserStore()
userStore.setToken(res.token)

// 从登录响应中提取用户信息并保存
if (res.userInfo) {
  userStore.setUserInfo({
    id: res.userInfo.id,
    username: res.userInfo.username,
    nickname: res.userInfo.username,
    avatar: res.userInfo.avatar || ''
  })
}
```

### 影响范围
- 聊天功能
- 所有依赖 `userStore.userInfo` 的功能

---

## 测试建议

### 测试问题1 (用户状态验证)
1. 使用管理员账户锁定一个测试用户
2. 尝试使用被锁定的用户登录
3. 验证是否显示"账户已被锁定"的错误提示
4. 对其他状态(禁用、过期、凭证过期)重复测试

### 测试问题2 (聊天功能)
1. 清除浏览器缓存和 localStorage
2. 重新登录
3. 打开聊天页面
4. 尝试发送消息
5. 验证消息是否成功发送

---

## 相关文件

### 问题1
- `d:\Projects\ViewX\src\main\java\com\flowbrain\viewx\config\SecurityConfig.java`
- `d:\Projects\ViewX\src\main\java\com\flowbrain\viewx\service\AuthenticationService.java`
- `d:\Projects\ViewX\docs\用户状态验证修复说明.md`

### 问题2
- `d:\Projects\ViewX\ViewX-frontend\src\stores\chat.ts`
- `d:\Projects\ViewX\ViewX-frontend\src\views\Login.vue`
- `d:\Projects\ViewX\ViewX-frontend\src\stores\user.ts`
